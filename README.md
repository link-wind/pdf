# PDF解析系统 - 公式解析错误修复

## 问题描述

在PDF解析系统中，存在两个主要问题：

1. **表格解析错误**：大模型返回格式错误（错误信息：InvalidParameter.Algo，无效URL）
2. **公式解析错误**：Markdown渲染失败，特别是对于包含未定义控制序列的公式（如`\Tilde`）

## 解决方案

### 公式解析错误修复

我们实现了一个完整的公式错误检测和大模型备用解析方案：

1. **错误检测**：在`formula_parser.py`中增强了`_has_latex_error`函数，能够检测多种可能导致Markdown渲染失败的错误：
   - 未定义的控制序列（如`\Tilde`、`\Alpha`等大写希腊字母）
   - 括号不匹配问题
   - 特殊字符转义问题
   - 命令与参数之间缺少花括号
   - 环境标签不匹配问题（`\begin`和`\end`）
   - 非法字符序列

2. **大模型备用解析**：
   - 添加了`parse_formula_with_llm`函数，用于在传统方法失败时使用大模型解析公式
   - 实现了自动错误检测和备用解析流程
   - 在配置文件中添加了相关参数控制

3. **配置项**：
   - `use_llm`: 是否使用大模型解析公式
   - `llm_priority`: 是否优先使用大模型（设为false表示传统方法优先）
   - `llm_fallback`: 当传统方法失败时是否使用大模型作为后备
   - `llm_api_key`: 大模型API密钥
   - `llm_max_retries`: 失败时最大重试次数
   - `llm_timeout`: API调用超时时间（秒）

## 测试

创建了测试脚本`test_formula_detection.py`，用于验证公式错误检测和大模型识别功能。测试结果表明系统能够：

1. 正确检测出常见的公式错误
2. 使用大模型成功解析并修复这些错误

## 使用方法

1. 确保配置文件中启用了大模型支持：
   ```yaml
   formula_parser:
     use_llm: true
     llm_fallback: true
     llm_api_key: "your_api_key"
   ```

2. 系统会自动检测公式错误，并在需要时使用大模型进行修复。

## 注意事项

- 大模型API调用需要网络连接和有效的API密钥
- 对于特别复杂的公式，大模型解析可能需要多次尝试
